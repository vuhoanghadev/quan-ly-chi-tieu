<!DOCTYPE html>
<html lang="vi" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Quản Lý Chi Tiêu Cá Nhân</title>

    <!-- Favicon cho tất cả trình duyệt và thiết bị -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="image/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="image/logo.png">

    <!-- Apple Touch Icon cho iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="image/logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="image/logo.png">
    <link rel="apple-touch-icon" sizes="144x144" href="image/logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="image/logo.png">
    <link rel="apple-touch-icon" sizes="114x114" href="image/logo.png">
    <link rel="apple-touch-icon" sizes="76x76" href="image/logo.png">
    <link rel="apple-touch-icon" sizes="72x72" href="image/logo.png">
    <link rel="apple-touch-icon" sizes="60x60" href="image/logo.png">
    <link rel="apple-touch-icon" sizes="57x57" href="image/logo.png">

    <!-- Android Chrome -->
    <link rel="icon" type="image/png" sizes="192x192" href="image/logo.png">
    <link rel="icon" type="image/png" sizes="128x128" href="image/logo.png">

    <!-- Windows Metro -->
    <meta name="msapplication-TileImage" content="image/logo.png">
    <meta name="msapplication-TileColor" content="#1f2937">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1f2937">
    <meta name="application-name" content="Quản Lý Chi Tiêu">
    <meta name="apple-mobile-web-app-title" content="Chi Tiêu">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">


    <!-- SEO Meta Tags -->
    <meta name="description" content="Ứng dụng quản lý chi tiêu cá nhân đơn giản và hiệu quả">
    <meta name="keywords" content="quản lý chi tiêu, tài chính cá nhân, ngân sách, thu chi">
    <meta name="author" content="Quản Lý Chi Tiêu App">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
        }

        /* Universal Form Element Styling for iOS Compatibility */
        input,
        select,
        textarea,
        button {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 16px;
            /* Prevents zoom on iOS */
            line-height: 1.5;
            box-sizing: border-box;
        }

        /* Select specific styling */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
            cursor: pointer;
        }

        /* Ensure consistent height across all form elements */
        input[type="text"],
        input[type="search"],
        input[type="date"],
        select {
            min-height: 44px;
            height: auto;
            display: flex;
            align-items: center;
            padding: 0.75rem;
        }

        /* iOS Safari specific fixes */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            select {
                background-color: #374151;
                border: 1px solid #4b5563;
                color: #e5e7eb;
            }

            select:focus {
                outline: none;
                box-shadow: 0 0 0 2px #6366f1;
                border-color: #6366f1;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Page Transition Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .view {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Slide-in for new items */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .new-item-animation {
            animation: slideInUp 0.5s ease-out forwards;
        }

        /* Chart container */
        #chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* Active Tab Button */
        .tab-btn.active {
            color: #818cf8 !important;
        }

        /* Đảm bảo active state luôn có ưu tiên cao nhất */
        .tab-btn.active:hover {
            color: #818cf8 !important;
        }

        /* Date Picker Icon Color */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }

        /* Transaction Type Toggle Button */
        .type-toggle-btn {
            transition: background-color 0.2s, color 0.2s;
        }

        .type-toggle-btn.active {
            font-weight: 700;
            color: white;
        }

        .type-toggle-btn.expense.active {
            background-color: #ef4444;
        }

        .type-toggle-btn.income.active {
            background-color: #22c55e;
        }

        /* FAB (Floating Action Button) */
        #add-fab {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        /* Modal Styles tối ưu 60fps */
        #add-edit-modal {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
            will-change: opacity, visibility;
            transform: translateZ(0);
            /* GPU layer */
            contain: layout style paint;
        }

        #add-edit-modal.modal-show {
            opacity: 1;
            visibility: visible;
        }

        #modal-content {
            transform: translate3d(0, 100%, 0);
            /* GPU acceleration */
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            contain: layout style paint;
            isolation: isolate;
            /* Tạo stacking context riêng */
        }

        /* Performance optimizations */
        #add-edit-modal * {
            box-sizing: border-box;
        }

        /* Tối ưu cho mobile */
        @media (max-width: 768px) {
            #modal-content {
                transition: transform 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
            }
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
            pointer-events: auto;
            max-width: 320px;
            min-width: 280px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid #22c55e;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        /* Input Validation Styles */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Loading Spinner */
        .spinner {
            border: 2px solid #374151;
            border-top: 2px solid #6366f1;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Loading state alignment */
        #btn-loading,
        .delete-btn-loading,
        #confirmOkLoading {
            align-items: center;
            justify-content: center;
        }

        #btn-loading:not(.hidden),
        .delete-btn-loading:not(.hidden),
        #confirmOkLoading:not(.hidden) {
            display: flex;
        }

        #btn-loading.hidden,
        .delete-btn-loading.hidden,
        #confirmOkLoading.hidden {
            display: none !important;
        }

        /* Numeric Input Optimization for Mobile */
        input[inputmode="numeric"] {
            text-align: right;
            /* Align numbers to the right for better UX */
            font-variant-numeric: tabular-nums;
            /* Use monospace numbers */
        }

        /* Better Mobile Touch Targets */
        @media (max-width: 768px) {
            .touch-target {
                min-height: 44px;
                min-width: 44px;
            }

            /* Enhanced numeric input for mobile */
            input[inputmode="numeric"] {
                font-size: 18px !important;
                /* Larger font for better readability */
                letter-spacing: 0.5px;
                /* Better spacing for numbers */
            }

            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast {
                max-width: none;
                min-width: auto;
            }

            /* Mobile Modal Improvements */
            #modal-content {
                border-radius: 20px 20px 0 0;
                max-height: 85vh;
                padding: 24px;
            }

            /* Better spacing for mobile */
            .transaction-item {
                padding: 16px !important;
            }

            /* Larger text for better readability */
            .transaction-amount {
                font-size: 1.125rem;
            }

            /* Better button spacing */
            .action-buttons {
                gap: 12px;
            }

            /* Improved form spacing */
            #transaction-form {
                gap: 20px;
            }

            /* Better input sizing */
            input,
            select,
            button {
                font-size: 16px !important;
                /* Prevents zoom on iOS */
                min-height: 44px !important;
                /* iOS minimum touch target */
                box-sizing: border-box !important;
            }

            /* Đảm bảo select có appearance đồng nhất */
            select {
                -webkit-appearance: none !important;
                appearance: none !important;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e") !important;
                background-repeat: no-repeat !important;
                background-position: right 0.75rem center !important;
                background-size: 1rem !important;
                padding-right: 2.5rem !important;
            }


        }





        /* Better focus states for accessibility */
        .focus-visible {
            outline: 2px solid #6366f1;
            outline-offset: 2px;
        }

        /* Improved scrolling */
        .smooth-scroll {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Keyboard handling */
        .keyboard-open {
            height: 100vh;
            overflow: hidden;
        }

        .keyboard-open #add-edit-modal {
            align-items: flex-start;
            padding-top: 20px;
        }

        /* Accessibility - Reduced Motion */
        @media (prefers-reduced-motion: reduce) {

            #add-edit-modal,
            #modal-content {
                transition-duration: 0.15s !important;
                transition-timing-function: ease !important;
            }
        }

        /* Critical Performance Optimizations */
        #add-edit-modal {
            contain: layout style paint;
            transform: translateZ(0);
            pointer-events: none;
        }

        #add-edit-modal.modal-show {
            pointer-events: auto;
        }

        #modal-content {
            contain: layout style paint;
            transform: translateZ(0);
        }

        /* Prevent layout thrashing */
        #modal-content * {
            will-change: auto;
        }

        /* Force hardware acceleration cho các elements quan trọng */
        .touch-target,
        button,
        input,
        select {
            transform: translateZ(0);
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .toast {
                border: 2px solid currentColor;
            }

            .input-error {
                border: 3px solid #ef4444 !important;
            }
        }

        /* Focus management for better accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Loading overlay for better UX */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .loading-overlay.hidden {
            display: none;
        }

        /* Custom margin-bottom cho mainContent */
        #mainContent.mb-20 {
            margin-bottom: 12rem;
        }

        /* iOS PWA Safe Area Support */
        /* Đảm bảo app container sử dụng toàn bộ viewport */
        #app {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        /* Header với safe area support cho iOS PWA */
        header {
            padding-top: env(safe-area-inset-top, 1rem);
            padding-left: env(safe-area-inset-left, 1rem);
            padding-right: env(safe-area-inset-right, 1rem);
            position: sticky;
            top: 0;
            z-index: 20;
        }

        /* Main content với safe area */
        #mainContent {
            padding-left: max(1rem, env(safe-area-inset-left));
            padding-right: max(1rem, env(safe-area-inset-right));
            padding-bottom: max(5rem, env(safe-area-inset-bottom));
        }

        /* Bottom navigation với safe area */
        #tab-nav {
            padding-bottom: env(safe-area-inset-bottom, 0);
            padding-left: env(safe-area-inset-left, 0);
            padding-right: env(safe-area-inset-right, 0);
        }

        /* FAB button với safe area */
        #add-fab {
            bottom: calc(6rem + env(safe-area-inset-bottom, 0));
            right: calc(1.25rem + env(safe-area-inset-right, 0));
        }

        /* Modal với safe area support */
        #add-edit-modal {
            padding-top: env(safe-area-inset-top, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
            padding-left: env(safe-area-inset-left, 0);
            padding-right: env(safe-area-inset-right, 0);
        }

        /* Toast container với safe area */
        .toast-container {
            top: calc(1.25rem + env(safe-area-inset-top, 0));
            right: calc(1.25rem + env(safe-area-inset-right, 0));
            left: calc(1.25rem + env(safe-area-inset-left, 0));
        }

        /* Đặc biệt cho iOS standalone mode */
        @media (display-mode: standalone) {

            /* Đảm bảo body không bị scroll qua header */
            body {
                overflow-x: hidden;
                position: relative;
            }

            /* Header cố định với backdrop */
            header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                background: rgba(31, 41, 55, 0.9);
            }

            /* Main content offset để tránh bị che bởi header */
            #mainContent {
                margin-top: calc(4rem + env(safe-area-inset-top, 0));
                padding-top: 1rem;
            }

            /* Loading screen cũng cần offset */
            #loading {
                margin-top: calc(4rem + env(safe-area-inset-top, 0));
            }
        }

        /* Responsive cho desktop */
        @media (min-width: 1024px) {
            header {
                padding-top: 1rem;
                padding-left: 1rem;
                padding-right: 1rem;
            }

            #mainContent {
                margin-top: 0;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }

            #add-fab {
                bottom: 2rem;
                right: 2rem;
            }
        }

        /* Đặc biệt cho iOS Safari và PWA */
        @supports (-webkit-touch-callout: none) {

            /* Đảm bảo không có scroll bounce */
            body {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: none;
            }

            /* Đảm bảo header luôn ở trên cùng */
            header {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
        }

        /* PWA Mode Styles */
        .pwa-mode {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow-x: hidden;
        }

        .pwa-mode header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1000 !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(31, 41, 55, 0.95) !important;
        }

        .pwa-mode #mainContent {
            margin-top: calc(4rem + env(safe-area-inset-top, 0)) !important;
            padding-top: 1rem !important;
        }

        .pwa-mode #loading {
            margin-top: calc(4rem + env(safe-area-inset-top, 0)) !important;
        }

        /* Xử lý cho các thiết bị có notch */
        @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3),
        screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2),
        screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3),
        screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3),
        screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) {

            .pwa-mode header {
                padding-top: max(env(safe-area-inset-top), 2.5rem) !important;
            }

            .pwa-mode #mainContent {
                margin-top: calc(4rem + max(env(safe-area-inset-top), 2.5rem)) !important;
            }

            .pwa-mode #loading {
                margin-top: calc(4rem + max(env(safe-area-inset-top), 2.5rem)) !important;
            }

            /* Enhanced Filter Styles */
            #advanced-filters {
                transition: all 0.3s ease-in-out;
                max-height: 0;
                overflow: hidden;
            }

            #advanced-filters:not(.hidden) {
                max-height: 500px;
            }

            #filter-results {
                animation: fadeIn 0.3s ease-in-out;
            }

            .filter-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.25rem 0.5rem;
                background: rgba(99, 102, 241, 0.2);
                border: 1px solid rgba(99, 102, 241, 0.3);
                border-radius: 0.5rem;
                font-size: 0.75rem;
                color: #a5b4fc;
                margin: 0.125rem;
            }

            .filter-badge .remove-filter {
                margin-left: 0.25rem;
                cursor: pointer;
                opacity: 0.7;
                transition: opacity 0.2s;
            }

            .filter-badge .remove-filter:hover {
                opacity: 1;
            }

            /* Search input with icon */
            .search-container {
                position: relative;
            }

            .search-container .search-icon {
                position: absolute;
                left: 0.75rem;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
                pointer-events: none;
            }

            /* iOS Select Fix */
            select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 0.75rem center;
                background-size: 1rem;
                padding-right: 2.5rem !important;
                min-height: 44px;
                /* iOS minimum touch target */
                line-height: 1.5;
                vertical-align: middle;
            }

            /* Đảm bảo tất cả select có chiều cao đồng nhất */
            select,
            input[type="text"],
            input[type="search"],
            input[type="date"] {
                min-height: 44px !important;
                box-sizing: border-box !important;
                display: flex !important;
                align-items: center !important;
            }

            /* iOS specific fixes */
            @supports (-webkit-touch-callout: none) {
                select {
                    font-size: 16px !important;
                    /* Ngăn zoom trên iOS */
                    -webkit-appearance: none !important;
                    appearance: none !important;
                    border-radius: 0.5rem !important;
                    background-color: #374151 !important;
                    border: 1px solid #4b5563 !important;
                    color: #e5e7eb !important;
                }

                select:focus {
                    outline: none !important;
                    box-shadow: 0 0 0 2px #6366f1 !important;
                    border-color: #6366f1 !important;
                }

                /* Đảm bảo option text hiển thị đúng */
                select option {
                    background-color: #374151 !important;
                    color: #e5e7eb !important;
                    padding: 0.5rem !important;
                }
            }

            /* Improved mobile filter layout */
            @media (max-width: 640px) {
                .filter-grid {
                    grid-template-columns: 1fr;
                    gap: 0.75rem;
                }

                .filter-grid-2 {
                    grid-template-columns: 1fr 1fr;
                    gap: 0.5rem;
                }

                /* Mobile select improvements */
                select {
                    min-height: 48px !important;
                    /* Tăng chiều cao cho mobile */
                    font-size: 16px !important;
                    /* Ngăn zoom */
                    padding: 0.75rem 2.5rem 0.75rem 0.75rem !important;
                }

                input[type="text"],
                input[type="search"],
                input[type="date"] {
                    min-height: 48px !important;
                    font-size: 16px !important;
                    padding: 0.75rem !important;
                }
            }

            /* iOS PWA Form Element Fixes */
            .pwa-mode select,
            .pwa-mode input[type="text"],
            .pwa-mode input[type="search"],
            .pwa-mode input[type="date"] {
                -webkit-appearance: none !important;
                appearance: none !important;
                border-radius: 0.5rem !important;
                min-height: 44px !important;
                font-size: 16px !important;
                background-color: #374151 !important;
                border: 1px solid #4b5563 !important;
                color: #e5e7eb !important;
                padding: 0.75rem !important;
                box-sizing: border-box !important;
            }

            .pwa-mode select {
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e") !important;
                background-repeat: no-repeat !important;
                background-position: right 0.75rem center !important;
                background-size: 1rem !important;
                padding-right: 2.5rem !important;
            }

            .pwa-mode select:focus,
            .pwa-mode input:focus {
                outline: none !important;
                box-shadow: 0 0 0 2px #6366f1 !important;
                border-color: #6366f1 !important;
            }

            /* Force consistent form element heights across all browsers */
            * {
                box-sizing: border-box;
            }

            input,
            select,
            textarea {
                vertical-align: baseline !important;
                line-height: 1.5 !important;
            }

            /* Specific iOS Safari fixes */
            @media screen and (-webkit-min-device-pixel-ratio: 0) {

                _::-webkit-full-page-media,
                _:future,
                :root select {
                    background-color: #374151 !important;
                    border: 1px solid #4b5563 !important;
                    color: #e5e7eb !important;
                    min-height: 44px !important;
                    padding: 0.75rem 2.5rem 0.75rem 0.75rem !important;
                }
            }

            /* WebKit specific select styling */
            @media screen and (-webkit-min-device-pixel-ratio: 0) {
                select {
                    background: #374151 url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 0.75rem center !important;
                    background-size: 1rem !important;
                    -webkit-appearance: none !important;
                    appearance: none !important;
                }
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">

    <div id="app" class="w-full min-h-screen bg-gray-900 flex flex-col relative">

        <header
            class="bg-gray-800/80 backdrop-blur-sm text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-20 border-b border-gray-700 lg:hidden">
            <h1 id="header-title" class="text-xl font-bold">Trang chủ</h1>
        </header>

        <div class="flex-1 lg:pl-24">
            <div id="loading" class="flex justify-center items-center p-8 flex-grow h-screen">
                <i class="fas fa-spinner fa-spin fa-3x text-indigo-500"></i>
            </div>

            <main id="mainContent" class="p-4 md:p-6 flex-grow hidden lg:max-w-4xl lg:mx-auto"
                style="margin-bottom: 170px; margin-top: 70px;">
                <div id="home-view" class="view">
                    <section class="mb-6 p-6 bg-gray-800 rounded-2xl shadow-lg">
                        <h2 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Số dư hiện tại</h2>
                        <p id="balance" class="text-4xl font-bold text-white mt-2">0 ₫</p>
                    </section>

                    <section class="mb-6 grid grid-cols-2 gap-4">
                        <div class="bg-green-800/50 p-4 rounded-xl">
                            <h3 class="text-sm font-medium text-green-300">Thu nhập tháng này</h3>
                            <p id="monthly-income" class="text-xl font-bold mt-1">0 ₫</p>
                        </div>
                        <div class="bg-red-800/50 p-4 rounded-xl">
                            <h3 class="text-sm font-medium text-red-300">Chi tiêu tháng này</h3>
                            <p id="monthly-expense" class="text-xl font-bold mt-1">0 ₫</p>
                        </div>
                    </section>

                    <section class="mb-6 p-4 bg-gray-800 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 text-center">Biểu đồ chi tiêu tháng</h3>
                        <div id="chart-container"><canvas id="expenseChart"></canvas></div>
                        <div id="chart-empty-message" class="text-center text-gray-400 py-10 hidden">
                            <i class="fas fa-chart-pie fa-3x mb-3 text-gray-600"></i>
                            <p>Chưa có dữ liệu chi tiêu để vẽ biểu đồ.</p>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 px-2">Giao dịch gần đây</h3>
                        <div id="recent-transaction-list" class="bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                        </div>
                    </section>
                </div>

                <div id="reports-view" class="view hidden">
                    <section class="mb-6 p-4 bg-gray-800 rounded-2xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Bộ lọc & Tìm kiếm</h3>
                            <button id="clear-filters-btn"
                                class="px-3 py-1 text-sm bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors text-gray-300 hover:text-white">
                                <i class="fas fa-times mr-1"></i>Xóa bộ lọc
                            </button>
                        </div>

                        <!-- Tìm kiếm nâng cao -->
                        <div class="mb-4">
                            <div class="relative">
                                <input type="search" id="search-input"
                                    placeholder="Tìm theo mô tả, số tiền hoặc danh mục..."
                                    class="w-full p-3 pl-10 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                                <i
                                    class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>

                        <!-- Bộ lọc nhanh -->
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                            <select id="type-filter"
                                class="p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-indigo-500 text-sm">
                                <option value="all">Tất cả loại</option>
                                <option value="income">Thu nhập</option>
                                <option value="expense">Chi tiêu</option>
                            </select>

                            <select id="category-filter"
                                class="p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-indigo-500 text-sm">
                                <option value="all">Tất cả danh mục</option>
                            </select>

                            <select id="sort-filter"
                                class="p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-indigo-500 text-sm">
                                <option value="date_desc">Mới nhất</option>
                                <option value="date_asc">Cũ nhất</option>
                                <option value="amount_desc">Số tiền cao</option>
                                <option value="amount_asc">Số tiền thấp</option>
                                <option value="name_asc">Tên A-Z</option>
                                <option value="name_desc">Tên Z-A</option>
                            </select>

                            <button id="advanced-filter-toggle"
                                class="p-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors text-white text-sm">
                                <i class="fas fa-filter mr-1"></i>Nâng cao
                            </button>
                        </div>

                        <!-- Bộ lọc nâng cao -->
                        <div id="advanced-filters" class="hidden space-y-4 p-4 bg-gray-700/50 rounded-lg">
                            <!-- Khoảng thời gian -->
                            <div>
                                <label class="text-sm font-medium text-gray-300 mb-2 block">Khoảng thời gian</label>
                                <select id="date-range-filter"
                                    class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-indigo-500 text-sm">
                                    <option value="all">Toàn bộ thời gian</option>
                                    <option value="today">Hôm nay</option>
                                    <option value="yesterday">Hôm qua</option>
                                    <option value="this_week">Tuần này</option>
                                    <option value="last_week">Tuần trước</option>
                                    <option value="this_month">Tháng này</option>
                                    <option value="last_month">Tháng trước</option>
                                    <option value="this_year">Năm nay</option>
                                    <option value="last_year">Năm trước</option>
                                    <option value="custom">Tùy chỉnh...</option>
                                </select>
                            </div>

                            <div id="custom-date-filters" class="grid grid-cols-2 gap-4 hidden">
                                <div>
                                    <label for="startDate" class="text-sm font-medium text-gray-300">Từ ngày</label>
                                    <input type="date" id="startDate"
                                        class="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200">
                                </div>
                                <div>
                                    <label for="endDate" class="text-sm font-medium text-gray-300">Đến ngày</label>
                                    <input type="date" id="endDate"
                                        class="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200">
                                </div>
                            </div>

                            <!-- Khoảng số tiền -->
                            <div>
                                <label class="text-sm font-medium text-gray-300 mb-2 block">Khoảng số tiền</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <input type="text" id="min-amount" placeholder="Từ (VD: 100.000)"
                                            inputmode="numeric" pattern="[0-9]*"
                                            class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-indigo-500 text-sm">
                                    </div>
                                    <div>
                                        <input type="text" id="max-amount" placeholder="Đến (VD: 1.000.000)"
                                            inputmode="numeric" pattern="[0-9]*"
                                            class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-indigo-500 text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hiển thị kết quả -->
                        <div id="filter-results" class="mt-4 text-sm text-gray-400 hidden">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span id="results-count">0</span> kết quả được tìm thấy
                        </div>
                    </section>
                    <section class="mb-6 p-4 bg-gray-800 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Thống kê giai đoạn</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div class="p-3 bg-gray-700 rounded-lg">
                                <p class="text-sm text-green-400">Tổng thu</p>
                                <p id="report-income" class="font-bold text-xl">0 ₫</p>
                            </div>
                            <div class="p-3 bg-gray-700 rounded-lg">
                                <p class="text-sm text-red-400">Tổng chi</p>
                                <p id="report-expense" class="font-bold text-xl">0 ₫</p>
                            </div>
                            <div class="p-3 bg-gray-700 rounded-lg">
                                <p class="text-sm text-gray-400">Chênh lệch</p>
                                <p id="report-net" class="font-bold text-xl">0 ₫</p>
                            </div>
                        </div>
                    </section>
                    <section class="bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                        <h3 class="text-lg font-semibold p-4 border-b border-gray-700">Tất cả giao dịch</h3>
                        <div id="full-transaction-list"></div>
                        <div id="empty-state" class="text-center p-12 text-gray-500 hidden">
                            <i class="fas fa-receipt fa-4x mb-4"></i>
                            <p class="font-semibold">Không có giao dịch nào</p>
                            <p class="text-sm">Hãy thử thay đổi bộ lọc hoặc thêm giao dịch mới nhé.</p>
                        </div>
                    </section>
                </div>

                <div id="budget-view" class="view hidden">
                    <section class="p-4 bg-gray-800 rounded-2xl shadow-lg">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Ngân sách tháng này</h3>
                            <p id="budget-month" class="text-sm text-gray-400"></p>
                        </div>
                        <div id="budget-list" class="space-y-6">
                        </div>
                        <div id="budget-empty-state" class="text-center p-12 text-gray-500 hidden">
                            <i class="fas fa-piggy-bank fa-4x mb-4"></i>
                            <p class="font-semibold">Chưa có ngân sách nào</p>
                            <p class="text-sm">Bạn có thể đặt ngân sách cho các danh mục chi tiêu.</p>
                        </div>
                    </section>
                </div>

                <div id="settings-view" class="view hidden">
                    <section class="mb-6 p-4 bg-gray-800 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Quản lý danh mục</h3>
                        <ul id="category-list" class="space-y-2 mb-4"></ul>
                        <form id="add-category-form" class="flex gap-2">
                            <input type="text" id="new-category-name" placeholder="Tên danh mục mới"
                                class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500"
                                required>
                            <button type="submit"
                                class="p-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-bold transition-colors"><i
                                    class="fas fa-plus"></i></button>
                        </form>
                    </section>
                    <section class="mb-6 p-4 bg-gray-800 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Quản lý dữ liệu</h3>
                        <button id="export-csv"
                            class="w-full p-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors"><i
                                class="fas fa-file-csv mr-2"></i> Xuất dữ liệu ra CSV</button>
                    </section>

                    <section
                        class="p-6 bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-lg border border-gray-700">
                        <div class="text-center">
                            <div
                                class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-code text-white text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-white mb-2">Phát triển bởi</h3>
                            <p class="text-xl font-bold text-indigo-400 mb-1">Vũ Hoàng Hà</p>
                            <p class="text-sm text-gray-400 mb-4">Full-stack Developer</p>

                            <div class="flex justify-center space-x-4 mb-4">
                                <a href="https://facebook.com/vuhoangha.dev" target="_blank" rel="noopener noreferrer"
                                    class="flex items-center space-x-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-white text-sm font-medium">
                                    <i class="fab fa-facebook-f"></i>
                                    <span>Facebook</span>
                                </a>
                                <button onclick="copyContact()"
                                    class="flex items-center space-x-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors text-white text-sm font-medium">
                                    <i class="fas fa-envelope"></i>
                                    <span>Liên hệ</span>
                                </button>
                            </div>

                            <div class="border-t border-gray-700 pt-4">
                                <p class="text-xs text-gray-500 leading-relaxed">
                                    <i class="fas fa-heart text-red-500 mr-1"></i>
                                    Được phát triển với tình yêu và đam mê công nghệ
                                </p>
                                <p class="text-xs text-gray-500 mt-1">
                                    © 2025 Vũ Hoàng Hà. All rights reserved.
                                </p>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>

        <nav id="tab-nav"
            class="fixed bottom-0 w-full bg-gray-800/80 backdrop-blur-sm border-t border-gray-700 flex justify-around z-30 lg:left-0 lg:top-0 lg:h-screen lg:w-24 lg:flex-col lg:justify-start lg:border-t-0 lg:border-r lg:pt-8 lg:gap-4">
            <button data-tab="home"
                class="tab-btn flex-1 p-4 text-center text-gray-400 transition-colors hover:text-indigo-400 lg:flex-none lg:w-full lg:py-4 touch-target">
                <i class="fas fa-home text-2xl"></i>
                <span class="text-xs block mt-1 lg:mt-2 lg:text-sm">Trang chủ</span>
            </button>
            <button data-tab="reports"
                class="tab-btn flex-1 p-4 text-center text-gray-400 transition-colors hover:text-indigo-400 lg:flex-none lg:w-full lg:py-4 touch-target">
                <i class="fas fa-chart-pie text-2xl"></i>
                <span class="text-xs block mt-1 lg:mt-2 lg:text-sm">Báo cáo</span>
            </button>
            <button data-tab="budget"
                class="tab-btn flex-1 p-4 text-center text-gray-400 transition-colors hover:text-indigo-400 lg:flex-none lg:w-full lg:py-4 touch-target">
                <i class="fas fa-piggy-bank text-2xl"></i>
                <span class="text-xs block mt-1 lg:mt-2 lg:text-sm">Ngân sách</span>
            </button>
            <button data-tab="settings"
                class="tab-btn flex-1 p-4 text-center text-gray-400 transition-colors hover:text-indigo-400 lg:flex-none lg:w-full lg:py-4 touch-target">
                <i class="fas fa-cog text-2xl"></i>
                <span class="text-xs block mt-1 lg:mt-2 lg:text-sm">Cài đặt</span>
            </button>
        </nav>

        <button id="add-fab"
            class="fixed bottom-24 right-5 lg:bottom-8 lg:right-8 bg-indigo-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg z-30 transform hover:scale-110 transition-transform touch-target">
            <i class="fas fa-plus text-2xl"></i>
        </button>


        <div id="add-edit-modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-end z-40"
            onclick="closeAddEditModalOnClickOutside(event)">
            <div id="modal-content"
                class="bg-gray-800 rounded-t-2xl p-6 w-full max-w-lg shadow-xl relative max-h-[90vh] overflow-y-auto">
                <button id="close-modal-btn"
                    class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors w-10 h-10 flex items-center justify-center rounded-full bg-gray-700/50 hover:bg-gray-700 touch-target">
                    <i class="fas fa-times"></i>
                </button>

                <form id="transaction-form" class="space-y-6" novalidate>
                    <h3 id="form-title" class="text-xl font-semibold text-center mb-4">Thêm giao dịch mới</h3>
                    <input type="hidden" id="editing-id">
                    <div id="add-mode-toggle" class="grid grid-cols-2 gap-3 p-2 bg-gray-700 rounded-lg">
                        <button type="button" data-type="expense"
                            class="type-toggle-btn expense p-3 rounded-md text-sm font-medium touch-target">Chi
                            tiêu</button>
                        <button type="button" data-type="income"
                            class="type-toggle-btn income p-3 rounded-md text-sm font-medium touch-target">Thu
                            nhập</button>
                    </div>
                    <div>
                        <input type="text" id="description" placeholder="Mô tả (vd: Ăn tối cùng bạn bè)"
                            class="w-full p-3 bg-gray-700 text-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 touch-target"
                            maxlength="200">
                        <div id="description-error" class="error-message">Mô tả không được để trống và tối đa 200 ký tự
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <input type="text" id="amount" placeholder="Số tiền (VD: 100.000)" inputmode="numeric"
                                pattern="[0-9]*"
                                class="p-3 bg-gray-700 text-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 touch-target w-full">
                            <div id="amount-error" class="error-message">Số tiền phải từ 1₫ trở lên</div>
                        </div>
                        <div>
                            <select id="category"
                                class="p-3 bg-gray-700 text-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 touch-target w-full"></select>
                            <div id="category-error" class="error-message">Vui lòng chọn danh mục</div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <button type="submit" id="save-transaction-btn"
                            class="w-full p-4 text-white font-bold rounded-lg shadow-md transition-all duration-200 touch-target">
                            <span id="btn-text">Thêm giao dịch</span>
                            <span id="btn-loading" class="hidden">
                                <span class="spinner"></span>
                                <span>Đang xử lý...</span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
            <div class="bg-gray-800 rounded-2xl p-6 w-11/12 max-w-sm text-center shadow-xl border border-gray-700">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-trash-alt text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold mb-2 text-white">Xác nhận xóa</h3>
                <p class="text-gray-300 mb-6 leading-relaxed">Bạn có chắc chắn muốn xóa vĩnh viễn giao dịch này không?
                    Hành động này không thể hoàn tác.</p>
                <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button id="cancelDelete"
                        class="px-6 py-3 bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors font-medium touch-target">Hủy
                        bỏ</button>
                    <button id="confirmDelete"
                        class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-medium touch-target">
                        <span class="delete-btn-text">Xóa giao dịch</span>
                        <span class="delete-btn-loading hidden">
                            <span class="spinner"></span>
                            <span>Đang xóa...</span>
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <div id="editCategoryModal"
            class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
            <div class="bg-gray-800 rounded-lg p-6 w-11/12 max-w-sm shadow-xl">
                <h3 class="text-lg font-bold mb-4 text-center">Sửa tên danh mục</h3>
                <form id="edit-category-form">
                    <input type="hidden" id="old-category-name">
                    <input type="text" id="edit-category-name"
                        class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg" required>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancelEditCategory"
                            class="px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors">Hủy</button>
                        <button type="submit"
                            class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">Lưu</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Custom Confirm Dialog -->
        <div id="customConfirmModal"
            class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
            <div class="bg-gray-800 rounded-2xl p-6 w-11/12 max-w-md text-center shadow-xl border border-gray-700">
                <div id="confirmIcon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i id="confirmIconClass" class="text-2xl"></i>
                </div>
                <h3 id="confirmTitle" class="text-xl font-bold mb-2 text-white"></h3>
                <p id="confirmMessage" class="text-gray-300 mb-6 leading-relaxed"></p>
                <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button id="confirmCancel"
                        class="px-6 py-3 bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors font-medium touch-target">Hủy
                        bỏ</button>
                    <button id="confirmOk" class="px-6 py-3 rounded-lg transition-colors font-medium touch-target">
                        <span id="confirmOkText">Xác nhận</span>
                        <span id="confirmOkLoading" class="hidden">
                            <span class="spinner"></span>
                            <span>Đang xử lý...</span>
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="text-center">
                <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 16px;"></div>
                <p class="text-white text-lg">Đang xử lý...</p>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="toast-container"></div>
    </div>

    <script type="module">
        // --- GLOBAL STATE & VARIABLES ---
        const TRANSACTIONS_KEY = 'expenseTrackerTransactions_v3';
        const CATEGORIES_KEY = 'expenseTrackerCategories_v3';
        const BUDGETS_KEY = 'expenseTrackerBudgets_v3';
        let transactionToDeleteId = null;
        let expenseChart = null;
        let allTransactions = [];
        let allCategories = [];
        let allBudgets = {};
        let currentTransactionType = 'expense';
        let currentTab = 'home';
        let tabScrollPositions = {
            home: 0,
            reports: 0,
            budget: 0,
            settings: 0
        };

        // --- DOM ELEMENTS ---
        const loadingEl = document.getElementById('loading');
        const mainContentEl = document.getElementById('mainContent');
        const headerTitleEl = document.getElementById('header-title');
        const views = {
            home: document.getElementById('home-view'),
            reports: document.getElementById('reports-view'),
            budget: document.getElementById('budget-view'),
            settings: document.getElementById('settings-view'),
        };
        const balanceEl = document.getElementById('balance');
        const monthlyIncomeEl = document.getElementById('monthly-income');
        const monthlyExpenseEl = document.getElementById('monthly-expense');
        const chartContainer = document.getElementById('chart-container');
        const chartEmptyMessage = document.getElementById('chart-empty-message');
        const recentTransactionListEl = document.getElementById('recent-transaction-list');

        // Add/Edit Modal elements
        const addEditModal = document.getElementById('add-edit-modal');
        const closeModalBtn = document.getElementById('close-modal-btn'); // ⭐ Lấy nút đóng modal
        const form = document.getElementById('transaction-form');
        const formTitle = document.getElementById('form-title');
        const editingIdInput = document.getElementById('editing-id');
        const addModeToggle = document.getElementById('add-mode-toggle');
        const descriptionInput = document.getElementById('description');
        const amountInput = document.getElementById('amount');
        const categoryInput = document.getElementById('category');
        const saveTransactionBtn = document.getElementById('save-transaction-btn');
        const addFab = document.getElementById('add-fab');

        const fullTransactionListEl = document.getElementById('full-transaction-list');
        const emptyStateEl = document.getElementById('empty-state');
        const searchInput = document.getElementById('search-input');
        const dateRangeFilter = document.getElementById('date-range-filter');
        const customDateFilters = document.getElementById('custom-date-filters');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const reportIncomeEl = document.getElementById('report-income');
        const reportExpenseEl = document.getElementById('report-expense');
        const reportNetEl = document.getElementById('report-net');

        // New filter elements
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const typeFilter = document.getElementById('type-filter');
        const categoryFilter = document.getElementById('category-filter');
        const sortFilter = document.getElementById('sort-filter');
        const advancedFilterToggle = document.getElementById('advanced-filter-toggle');
        const advancedFilters = document.getElementById('advanced-filters');
        const minAmountInput = document.getElementById('min-amount');
        const maxAmountInput = document.getElementById('max-amount');
        const filterResults = document.getElementById('filter-results');
        const resultsCount = document.getElementById('results-count');
        const budgetListEl = document.getElementById('budget-list');
        const budgetEmptyStateEl = document.getElementById('budget-empty-state');
        const budgetMonthEl = document.getElementById('budget-month');
        const categoryListEl = document.getElementById('category-list');
        const addCategoryForm = document.getElementById('add-category-form');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const exportCsvBtn = document.getElementById('export-csv');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDelete');
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        const tabNav = document.getElementById('tab-nav');
        const editCategoryModal = document.getElementById('editCategoryModal');
        const editCategoryForm = document.getElementById('edit-category-form');
        const oldCategoryNameInput = document.getElementById('old-category-name');
        const editCategoryNameInput = document.getElementById('edit-category-name');
        const cancelEditCategoryBtn = document.getElementById('cancelEditCategory');

        // --- UTILS ---
        const formatCurrency = (value) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);

        // --- TOAST NOTIFICATION SYSTEM ---
        const Toast = {
            container: null,

            init() {
                this.container = document.getElementById('toast-container');
            },

            show(message, type = 'info', duration = 4000) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                const iconMap = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };

                toast.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <i class="fas ${iconMap[type]} text-lg flex-shrink-0"></i>
                        <div class="flex-1">
                            <p class="text-gray-200 text-sm leading-relaxed">${message}</p>
                        </div>
                        <button class="toast-close text-gray-400 hover:text-white ml-2 flex-shrink-0">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                `;

                this.container.appendChild(toast);

                // Trigger animation
                setTimeout(() => toast.classList.add('show'), 10);

                // Auto remove
                const autoRemove = setTimeout(() => this.remove(toast), duration);

                // Manual close
                toast.querySelector('.toast-close').addEventListener('click', () => {
                    clearTimeout(autoRemove);
                    this.remove(toast);
                });

                return toast;
            },

            remove(toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            },

            success(message, duration) { return this.show(message, 'success', duration); },
            error(message, duration) { return this.show(message, 'error', duration); },
            warning(message, duration) { return this.show(message, 'warning', duration); },
            info(message, duration) { return this.show(message, 'info', duration); }
        };

        // --- VALIDATION SYSTEM ---
        const Validator = {
            showError(inputId, message) {
                const input = document.getElementById(inputId);
                const errorEl = document.getElementById(`${inputId}-error`);

                input.classList.add('input-error');
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.classList.add('show');
                }
            },

            clearError(inputId) {
                const input = document.getElementById(inputId);
                const errorEl = document.getElementById(`${inputId}-error`);

                input.classList.remove('input-error');
                if (errorEl) {
                    errorEl.classList.remove('show');
                }
            },

            clearAllErrors() {
                ['description', 'amount', 'category'].forEach(id => this.clearError(id));
            },

            validateDescription(value) {
                if (!value || value.trim().length === 0) {
                    return 'Mô tả không được để trống';
                }
                if (value.length > 200) {
                    return 'Mô tả không được vượt quá 200 ký tự';
                }
                return null;
            },

            validateAmount(value) {
                // Chấp nhận cả dấu chấm và dấu phẩy, loại bỏ khoảng trắng
                const cleanValue = value.toString().replace(/[\s,]/g, '').replace(/\./g, '');
                const num = parseFloat(cleanValue);

                if (!cleanValue || cleanValue.trim() === '' || isNaN(num)) {
                    return 'Vui lòng nhập số tiền hợp lệ';
                }
                if (num < 1) {
                    return 'Số tiền phải lớn hơn 0₫';
                }
                if (num > 999999999999) {
                    return 'Số tiền quá lớn';
                }
                return null;
            },

            validateCategory(value) {
                if (!value || value.trim().length === 0) {
                    return 'Vui lòng chọn danh mục';
                }
                return null;
            },

            validateForm() {
                this.clearAllErrors();
                let isValid = true;

                const description = descriptionInput.value.trim();
                const amount = amountInput.value;
                const category = categoryInput.value;

                const descError = this.validateDescription(description);
                if (descError) {
                    this.showError('description', descError);
                    isValid = false;
                }

                const amountError = this.validateAmount(amount);
                if (amountError) {
                    this.showError('amount', amountError);
                    isValid = false;
                }

                const categoryError = this.validateCategory(category);
                if (categoryError) {
                    this.showError('category', categoryError);
                    isValid = false;
                }

                return isValid;
            }
        };

        // --- LOADING STATE MANAGEMENT ---
        const LoadingState = {
            setButtonLoading(buttonId, isLoading) {
                const button = document.getElementById(buttonId);
                const textEl = document.getElementById('btn-text');
                const loadingEl = document.getElementById('btn-loading');

                console.log('Setting loading state:', { buttonId, isLoading, button, textEl, loadingEl }); // Debug log

                if (isLoading) {
                    button.disabled = true;
                    if (textEl) textEl.classList.add('hidden');
                    if (loadingEl) loadingEl.classList.remove('hidden');
                } else {
                    button.disabled = false;
                    if (textEl) textEl.classList.remove('hidden');
                    if (loadingEl) loadingEl.classList.add('hidden');
                }
            },

            showOverlay(message = 'Đang xử lý...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = overlay.querySelector('p');
                text.textContent = message;
                overlay.classList.remove('hidden');
            },

            hideOverlay() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('hidden');
            }
        };

        // --- CUSTOM CONFIRM DIALOG ---
        const ConfirmDialog = {
            show(options = {}) {
                return new Promise((resolve) => {
                    const modal = document.getElementById('customConfirmModal');
                    const icon = document.getElementById('confirmIcon');
                    const iconClass = document.getElementById('confirmIconClass');
                    const title = document.getElementById('confirmTitle');
                    const message = document.getElementById('confirmMessage');
                    const cancelBtn = document.getElementById('confirmCancel');
                    const okBtn = document.getElementById('confirmOk');
                    const okText = document.getElementById('confirmOkText');
                    const okLoading = document.getElementById('confirmOkLoading');

                    // Set content
                    title.textContent = options.title || 'Xác nhận';
                    message.textContent = options.message || 'Bạn có chắc chắn muốn thực hiện hành động này?';
                    okText.textContent = options.confirmText || 'Xác nhận';
                    cancelBtn.textContent = options.cancelText || 'Hủy bỏ';

                    // Set icon and colors
                    const type = options.type || 'warning';
                    icon.className = 'w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4';
                    okBtn.className = 'px-6 py-3 rounded-lg transition-colors font-medium touch-target';

                    switch (type) {
                        case 'danger':
                            icon.classList.add('bg-red-100');
                            iconClass.className = 'fas fa-exclamation-triangle text-red-600 text-2xl';
                            okBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white');
                            break;
                        case 'warning':
                            icon.classList.add('bg-yellow-100');
                            iconClass.className = 'fas fa-exclamation-triangle text-yellow-600 text-2xl';
                            okBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700', 'text-white');
                            break;
                        case 'info':
                            icon.classList.add('bg-blue-100');
                            iconClass.className = 'fas fa-info-circle text-blue-600 text-2xl';
                            okBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white');
                            break;
                        default:
                            icon.classList.add('bg-gray-100');
                            iconClass.className = 'fas fa-question-circle text-gray-600 text-2xl';
                            okBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
                    }

                    // Show modal
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';

                    // Handle events
                    const handleCancel = () => {
                        this.hide();
                        resolve(false);
                    };

                    const handleConfirm = async () => {
                        if (options.onConfirm) {
                            // Show loading state
                            okText.classList.add('hidden');
                            okLoading.classList.remove('hidden');
                            okBtn.disabled = true;
                            cancelBtn.disabled = true;

                            try {
                                await options.onConfirm();
                                this.hide();
                                resolve(true);
                            } catch (error) {
                                // Reset button state on error
                                okText.classList.remove('hidden');
                                okLoading.classList.add('hidden');
                                okBtn.disabled = false;
                                cancelBtn.disabled = false;
                                Toast.error('Có lỗi xảy ra, vui lòng thử lại');
                            }
                        } else {
                            this.hide();
                            resolve(true);
                        }
                    };

                    // Add event listeners
                    cancelBtn.onclick = handleCancel;
                    okBtn.onclick = handleConfirm;

                    // Close on escape key
                    const handleEscape = (e) => {
                        if (e.key === 'Escape') {
                            handleCancel();
                            document.removeEventListener('keydown', handleEscape);
                        }
                    };
                    document.addEventListener('keydown', handleEscape);
                });
            },

            hide() {
                const modal = document.getElementById('customConfirmModal');
                modal.classList.add('hidden');
                document.body.style.overflow = '';

                // Reset button states
                const okText = document.getElementById('confirmOkText');
                const okLoading = document.getElementById('confirmOkLoading');
                const okBtn = document.getElementById('confirmOk');
                const cancelBtn = document.getElementById('confirmCancel');

                okText.classList.remove('hidden');
                okLoading.classList.add('hidden');
                okBtn.disabled = false;
                cancelBtn.disabled = false;
            }
        };

        // --- MOBILE UX ENHANCEMENTS ---
        const MobileUX = {
            init() {
                this.setupSwipeGestures();
            },

            setupSwipeGestures() {
                let startX = 0;
                let startY = 0;

                document.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, { passive: true });

                document.addEventListener('touchend', (e) => {
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;

                    const deltaX = endX - startX;
                    const deltaY = endY - startY;

                    // Horizontal swipe detection
                    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                        if (deltaX > 0) {
                            // Swipe right - could close modal
                            if (addEditModal.classList.contains('modal-show')) {
                                closeAddEditModal();
                            }
                        }
                    }
                }, { passive: true });
            },

            addHapticFeedback(element) {
                element.classList.add('haptic-feedback');
                setTimeout(() => {
                    element.classList.remove('haptic-feedback');
                }, 100);
            },

            // Enhanced interactions
            setupAdvancedInteractions() {
                this.setupDoubleClickToEdit();
                this.setupKeyboardShortcuts();
                this.setupSmartFocus();
                this.setupContextualHelp();
            },

            setupDoubleClickToEdit() {
                // Double click on transaction to edit
                document.addEventListener('dblclick', (e) => {
                    const transactionItem = e.target.closest('.transaction-item');
                    if (transactionItem) {
                        const editBtn = transactionItem.querySelector('.edit-btn');
                        if (editBtn) {
                            editBtn.click();
                            this.addHapticFeedback(transactionItem);
                        }
                    }
                });
            },

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + N: New transaction
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                        e.preventDefault();
                        if (addEditModal.classList.contains('hidden')) {
                            setupFormForAdd();
                            Toast.info('Phím tắt: Ctrl+N để thêm giao dịch mới');
                        }
                    }

                    // Escape: Close modals
                    if (e.key === 'Escape') {
                        if (addEditModal.classList.contains('modal-show')) {
                            closeAddEditModal();
                        }
                        if (!deleteModal.classList.contains('hidden')) {
                            closeDeleteModal();
                        }
                    }

                    // Tab navigation improvements
                    if (e.key === 'Tab' && !e.shiftKey) {
                        const currentTab = document.querySelector('.tab-btn.active');
                        const allTabs = document.querySelectorAll('.tab-btn');
                        const currentIndex = Array.from(allTabs).indexOf(currentTab);

                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            const nextIndex = (currentIndex + 1) % allTabs.length;
                            allTabs[nextIndex].click();
                        }
                    }
                });
            },

            setupSmartFocus() {
                // Auto-focus search when switching to reports
                const reportsTab = document.querySelector('[data-tab="reports"]');
                reportsTab.addEventListener('click', () => {
                    setTimeout(() => {
                        const searchInput = document.getElementById('search-input');
                        if (searchInput && window.innerWidth > 768) {
                            searchInput.focus();
                        }
                    }, 100);
                });

                // Smart form focus management will be handled in main form submit handler
            },

            setupContextualHelp() {
                // Show helpful tips based on user actions
                let tipShown = false;

                // First time adding transaction
                addFab.addEventListener('click', () => {
                    if (!tipShown && allTransactions.length === 0) {
                        setTimeout(() => {
                            Toast.info('💡 Mẹo: Bạn có thể nhấn đúp vào giao dịch để chỉnh sửa nhanh', 5000);
                            tipShown = true;
                        }, 2000);
                    }
                });

                // Show keyboard shortcut tip
                let shortcutTipShown = false;
                document.addEventListener('click', () => {
                    if (!shortcutTipShown && allTransactions.length > 5) {
                        setTimeout(() => {
                            Toast.info('⌨️ Mẹo: Nhấn Ctrl+N để thêm giao dịch nhanh', 4000);
                            shortcutTipShown = true;
                        }, 3000);
                    }
                });
            }
        };

        // --- DATA MANAGEMENT (localStorage) ---
        const Storage = {
            get: (key, defaultValue = '[]') => JSON.parse(localStorage.getItem(key) || defaultValue),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
        };

        function loadData() {
            allTransactions = Storage.get(TRANSACTIONS_KEY).map(t => ({ ...t, createdAt: new Date(t.createdAt) }));
            allBudgets = Storage.get(BUDGETS_KEY, '{}');
            allCategories = Storage.get(CATEGORIES_KEY);
            if (allCategories.length === 0) {
                allCategories = ["Ăn uống", "Di chuyển", "Giải trí", "Mua sắm", "Hóa đơn", "Sức khỏe", "Lương", "Đầu tư", "Khác"];
                Storage.set(CATEGORIES_KEY, allCategories);
            }
        }

        // --- NAVIGATION ---
        const switchTab = (tabName) => {
            // Lưu vị trí cuộn của tab hiện tại
            if (currentTab) {
                tabScrollPositions[currentTab] = window.pageYOffset || document.documentElement.scrollTop;
            }

            // Ẩn tất cả views
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[tabName]) {
                views[tabName].classList.remove('hidden');
            }

            // Cập nhật active state cho tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                // Đảm bảo reset về màu mặc định
                btn.style.color = '';
            });
            const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                // Force active color
                activeBtn.style.color = '#818cf8';
            }

            // Cập nhật title
            const titles = { home: 'Trang chủ', reports: 'Báo cáo', budget: 'Ngân sách', settings: 'Cài đặt' };
            headerTitleEl.textContent = titles[tabName] || 'Trang chủ';

            // Cập nhật currentTab
            currentTab = tabName;

            // Khôi phục vị trí cuộn cho tab mới
            setTimeout(() => {
                const savedPosition = tabScrollPositions[tabName] || 0;
                window.scrollTo({
                    top: savedPosition,
                    behavior: 'smooth'
                });
            }, 50); // Delay nhỏ để đảm bảo DOM đã render

            // Render data cho các tab cần thiết
            if (tabName === 'budget') renderBudgetView();
            if (tabName === 'reports') processAndRenderData();
        };

        // --- CATEGORY MANAGEMENT ---
        function renderCategories() {
            categoryListEl.innerHTML = '';
            allCategories.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-lg';
                li.innerHTML = `<span>${cat}</span><div class="space-x-3"><button data-category="${cat}" class="edit-category-btn text-indigo-400 hover:text-indigo-300 transition-colors"><i class="fas fa-edit"></i></button><button data-category="${cat}" class="delete-category-btn text-red-400 hover:text-red-300 transition-colors"><i class="fas fa-trash"></i></button></div>`;
                categoryListEl.appendChild(li);
            });
            populateCategoryDropdown();
        }

        function populateCategoryDropdown() {
            const currentCategory = categoryInput.value;
            const currentFilterCategory = categoryFilter.value;

            // Populate transaction form dropdown
            categoryInput.innerHTML = allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            if (allCategories.includes(currentCategory)) categoryInput.value = currentCategory;

            // Populate filter dropdown
            categoryFilter.innerHTML = '<option value="all">Tất cả danh mục</option>' +
                allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            if (allCategories.includes(currentFilterCategory)) categoryFilter.value = currentFilterCategory;
        }

        function clearAllFilters() {
            searchInput.value = '';
            typeFilter.value = 'all';
            categoryFilter.value = 'all';
            sortFilter.value = 'date_desc';
            dateRangeFilter.value = 'all';
            startDateInput.value = '';
            endDateInput.value = '';
            minAmountInput.value = '';
            maxAmountInput.value = '';
            customDateFilters.classList.add('hidden');
            advancedFilters.classList.add('hidden');
            advancedFilterToggle.innerHTML = '<i class="fas fa-filter mr-1"></i>Nâng cao';
            processAndRenderData();
            Toast.info('Đã xóa tất cả bộ lọc');
        }

        function showEditCategoryModal(oldName) {
            oldCategoryNameInput.value = oldName;
            editCategoryNameInput.value = oldName;
            editCategoryModal.classList.remove('hidden');
            editCategoryNameInput.focus();
        }
        function closeEditCategoryModal() { editCategoryModal.classList.add('hidden'); }

        // --- BUDGET MANAGEMENT ---
        function renderBudgetView() {
            const now = new Date();
            budgetMonthEl.textContent = `Tháng ${now.getMonth() + 1}/${now.getFullYear()}`;
            budgetListEl.innerHTML = '';

            const expenseCategories = allCategories.filter(cat => cat.toLowerCase() !== 'lương' && cat.toLowerCase() !== 'thu nhập' && cat.toLowerCase() !== 'đầu tư');

            if (expenseCategories.length === 0) {
                budgetEmptyStateEl.classList.remove('hidden');
                return;
            }
            budgetEmptyStateEl.classList.add('hidden');

            const transactionsThisMonth = allTransactions.filter(t => t.createdAt.getMonth() === now.getMonth() && t.createdAt.getFullYear() === now.getFullYear());

            expenseCategories.forEach(cat => {
                const spent = transactionsThisMonth.filter(t => t.type === 'expense' && t.category === cat).reduce((sum, t) => sum + t.amount, 0);
                const budget = allBudgets[cat] || 0;
                const percentage = budget > 0 ? Math.min((spent / budget) * 100, 100) : 0;
                let progressBarColor = 'bg-green-500';
                if (percentage > 90) progressBarColor = 'bg-red-500';
                else if (percentage > 70) progressBarColor = 'bg-yellow-500';

                const item = document.createElement('div');
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-2 text-sm">
                        <span class="font-semibold">${cat}</span>
                        <span class="text-gray-400">${formatCurrency(spent)} / ${budget > 0 ? formatCurrency(budget) : 'Chưa đặt'}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div class="${progressBarColor} h-2.5 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                    </div>
                    <div class="mt-3">
                        <input type="number" data-category="${cat}" value="${budget > 0 ? budget : ''}" placeholder="Nhập số tiền ngân sách..." class="budget-input w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                `;
                budgetListEl.appendChild(item);
            });
        }

        // --- DATA PROCESSING & RENDERING ---
        function getFilteredTransactions() {
            let filtered = [...allTransactions];

            // Apply filters
            const searchTerm = searchInput.value.toLowerCase().trim();
            const typeFilterValue = typeFilter.value;
            const categoryFilterValue = categoryFilter.value;
            const { startDate, endDate } = getDateRangeFromFilter();
            const { minAmount, maxAmount } = getAmountRange();

            // Filter by search term (description, amount, category)
            if (searchTerm) {
                filtered = filtered.filter(t => {
                    const matchesDescription = t.description.toLowerCase().includes(searchTerm);
                    const matchesCategory = t.category.toLowerCase().includes(searchTerm);
                    const matchesAmount = formatCurrency(t.amount).toLowerCase().includes(searchTerm) ||
                        t.amount.toString().includes(searchTerm);
                    return matchesDescription || matchesCategory || matchesAmount;
                });
            }

            // Filter by transaction type
            if (typeFilterValue !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilterValue);
            }

            // Filter by category
            if (categoryFilterValue !== 'all') {
                filtered = filtered.filter(t => t.category === categoryFilterValue);
            }

            // Filter by date range
            if (startDate || endDate) {
                filtered = filtered.filter(t => {
                    const tDate = t.createdAt;
                    return (!startDate || tDate >= startDate) && (!endDate || tDate <= endDate);
                });
            }

            // Filter by amount range
            if (minAmount !== null || maxAmount !== null) {
                filtered = filtered.filter(t => {
                    return (minAmount === null || t.amount >= minAmount) &&
                        (maxAmount === null || t.amount <= maxAmount);
                });
            }

            // Apply sorting
            const sortValue = sortFilter.value;
            filtered.sort((a, b) => {
                switch (sortValue) {
                    case 'date_asc':
                        return a.createdAt.getTime() - b.createdAt.getTime();
                    case 'date_desc':
                        return b.createdAt.getTime() - a.createdAt.getTime();
                    case 'amount_asc':
                        return a.amount - b.amount;
                    case 'amount_desc':
                        return b.amount - a.amount;
                    case 'name_asc':
                        return a.description.localeCompare(b.description, 'vi');
                    case 'name_desc':
                        return b.description.localeCompare(a.description, 'vi');
                    default:
                        return b.createdAt.getTime() - a.createdAt.getTime();
                }
            });

            return filtered;
        }

        function getAmountRange() {
            const minAmountValue = minAmountInput.value.trim();
            const maxAmountValue = maxAmountInput.value.trim();

            const parseAmount = (value) => {
                if (!value) return null;
                const cleanValue = value.replace(/[\s,\.]/g, '');
                const num = parseFloat(cleanValue);
                return isNaN(num) ? null : num;
            };

            return {
                minAmount: parseAmount(minAmountValue),
                maxAmount: parseAmount(maxAmountValue)
            };
        }

        function processAndRenderData() {
            const filteredTransactions = getFilteredTransactions();
            renderTransactionList(filteredTransactions, fullTransactionListEl, emptyStateEl);
            renderTransactionList(allTransactions.slice(0, 5), recentTransactionListEl, null, `<div class="text-center p-10 text-gray-500"><i class="fas fa-receipt fa-3x mb-3"></i><p>Chưa có giao dịch gần đây.</p></div>`);
            updateHomeDashboard(allTransactions);
            updateChart(allTransactions);
            updateReportSummary(filteredTransactions);
            updateFilterResults(filteredTransactions.length);
        }

        function updateFilterResults(count) {
            resultsCount.textContent = count.toLocaleString('vi-VN');
            if (count > 0 || hasActiveFilters()) {
                filterResults.classList.remove('hidden');
            } else {
                filterResults.classList.add('hidden');
            }
        }

        function hasActiveFilters() {
            return searchInput.value.trim() !== '' ||
                typeFilter.value !== 'all' ||
                categoryFilter.value !== 'all' ||
                dateRangeFilter.value !== 'all' ||
                minAmountInput.value.trim() !== '' ||
                maxAmountInput.value.trim() !== '';
        }

        function renderTransactionList(transactions, containerEl, emptyEl, emptyText = "Chưa có giao dịch nào.") {
            containerEl.innerHTML = '';
            if (emptyEl) containerEl.appendChild(emptyEl);

            if (transactions.length === 0) {
                if (emptyEl) { emptyEl.classList.remove('hidden'); } else { containerEl.innerHTML = emptyText; }
            } else {
                if (emptyEl) emptyEl.classList.add('hidden');
                transactions.forEach(t => addTransactionToDOM(t, containerEl));
            }
        }

        function addTransactionToDOM(transaction, containerEl, isNew = false) {
            const { id, description, amount, type, createdAt, category } = transaction;
            const item = document.createElement('div');
            item.className = 'transaction-item flex items-center justify-between p-4 border-b border-gray-700/50 last:border-b-0';
            if (isNew) { item.classList.add('new-item-animation'); }

            const isIncome = type === 'income';
            const sign = isIncome ? '+' : '-';
            const amountColor = isIncome ? 'text-green-400' : 'text-red-400';
            const icon = isIncome ? 'fa-arrow-up' : 'fa-arrow-down';
            const formattedDate = createdAt.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });

            item.innerHTML = `
                <div class="flex items-center space-x-4 min-w-0 flex-1">
                    <div class="w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center ${isIncome ? 'bg-green-900/50' : 'bg-red-900/50'}">
                        <i class="fas ${icon} ${amountColor} text-lg"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <p class="font-semibold text-gray-100 truncate text-base">${description}</p>
                        <p class="text-sm text-gray-400 mt-1">${category || ''} <span class="mx-1">&bull;</span> ${formattedDate}</p>
                    </div>
                </div>
                <div class="text-right flex-shrink-0 ml-4">
                    <p class="font-bold ${amountColor} transaction-amount text-lg">${sign}${formatCurrency(amount)}</p>
                    <div class="action-buttons flex space-x-3 mt-2">
                        <button data-id="${id}" class="edit-btn text-gray-400 hover:text-indigo-400 text-sm transition-colors touch-target px-2 py-1">
                            <i class="fas fa-edit mr-1"></i>Sửa
                        </button>
                        <button data-id="${id}" class="delete-btn text-gray-400 hover:text-red-400 text-sm transition-colors touch-target px-2 py-1">
                            <i class="fas fa-trash-alt mr-1"></i>Xóa
                        </button>
                    </div>
                </div>
            `;

            containerEl.prepend(item);
        }

        function updateHomeDashboard(transactions) {
            const total = transactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
            balanceEl.textContent = formatCurrency(total);
            balanceEl.className = 'text-4xl font-bold mt-2 transition-colors';
            balanceEl.classList.add(total < 0 ? 'text-red-400' : 'text-green-400');

            const now = new Date();
            const thisMonthTransactions = transactions.filter(t => t.createdAt.getMonth() === now.getMonth() && t.createdAt.getFullYear() === now.getFullYear());
            const monthlyIncome = thisMonthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const monthlyExpense = thisMonthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            monthlyIncomeEl.textContent = formatCurrency(monthlyIncome);
            monthlyExpenseEl.textContent = formatCurrency(monthlyExpense);
        }

        function updateReportSummary(transactions) {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const net = income - expense;
            reportIncomeEl.textContent = formatCurrency(income);
            reportExpenseEl.textContent = formatCurrency(expense);
            reportNetEl.textContent = formatCurrency(net);
            reportNetEl.className = 'font-bold text-xl transition-colors';
            reportNetEl.classList.add(net < 0 ? 'text-red-400' : 'text-green-400');
        }

        function updateChart(transactions) {
            const now = new Date();
            const thisMonthExpenses = transactions.filter(t => t.type === 'expense' && t.createdAt.getMonth() === now.getMonth() && t.createdAt.getFullYear() === now.getFullYear());
            const expenseData = thisMonthExpenses.reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
            const labels = Object.keys(expenseData);
            const data = Object.values(expenseData);
            if (expenseChart) expenseChart.destroy();
            if (labels.length === 0) { chartContainer.classList.add('hidden'); chartEmptyMessage.classList.remove('hidden'); return; }
            chartContainer.classList.remove('hidden');
            chartEmptyMessage.classList.add('hidden');
            const ctx = document.getElementById('expenseChart').getContext('2d');
            expenseChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'], borderColor: '#1f2937', borderWidth: 4, hoverOffset: 8 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: '#e2e8f0', padding: 20, font: { size: 12, family: "'Be Vietnam Pro', sans-serif" } } }, tooltip: { bodyFont: { family: "'Be Vietnam Pro', sans-serif" }, titleFont: { family: "'Be Vietnam Pro', sans-serif" } } } } });
        }

        // --- FORM & CRUD ---
        function updateFormUI() {
            const isExpense = currentTransactionType === 'expense';
            document.querySelector('.type-toggle-btn.expense').classList.toggle('active', isExpense);
            document.querySelector('.type-toggle-btn.income').classList.toggle('active', !isExpense);

            const isEditing = !!editingIdInput.value;
            if (isEditing) return;

            // Update button colors
            saveTransactionBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');

            // Update button text without destroying the loading structure
            const btnTextEl = document.getElementById('btn-text');
            if (btnTextEl) {
                if (isExpense) {
                    saveTransactionBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    btnTextEl.innerHTML = `<i class="fas fa-minus-circle mr-2"></i> Thêm Chi Tiêu`;
                } else {
                    saveTransactionBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    btnTextEl.innerHTML = `<i class="fas fa-plus-circle mr-2"></i> Thêm Thu Nhập`;
                }
            }
        }

        function openAddEditModal() {
            // Performance monitoring
            if (performance.mark) performance.mark('modal-open-start');

            const modalContent = document.getElementById('modal-content');

            // Prevent body scroll
            document.body.style.overflow = 'hidden';

            // Prepare for optimal GPU acceleration
            modalContent.style.transform = 'translate3d(0, 100%, 0)';
            modalContent.style.willChange = 'transform';

            // Show modal background
            addEditModal.classList.add('modal-show');

            // Triple RAF cho 60fps guarantee
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        modalContent.style.transform = 'translate3d(0, 0, 0)';

                        // Performance monitoring
                        if (performance.mark) {
                            performance.mark('modal-open-end');
                            performance.measure('modal-animation', 'modal-open-start', 'modal-open-end');
                        }
                    });
                });
            });

            // Focus input sau animation
            setTimeout(() => {
                if (addEditModal.classList.contains('modal-show')) {
                    modalContent.style.willChange = 'auto'; // Memory cleanup
                    descriptionInput.focus();
                }
            }, 250);
        }

        function closeAddEditModal() {
            const modalContent = document.getElementById('modal-content');

            // Prepare for GPU acceleration
            modalContent.style.willChange = 'transform';

            // Trigger slide down animation
            modalContent.style.transform = 'translate3d(0, 100%, 0)';

            // Hide modal background sau animation (250ms)
            setTimeout(() => {
                addEditModal.classList.remove('modal-show');
                document.body.style.overflow = '';
                modalContent.style.willChange = 'auto'; // Cleanup
            }, 250);

            // Clear validation errors ngay lập tức
            Validator.clearAllErrors();
        }

        function closeAddEditModalOnClickOutside(event) {
            if (event.target.id === 'add-edit-modal') {
                closeAddEditModal();
            }
        }



        function setupFormForAdd() {
            form.reset();
            editingIdInput.value = '';
            formTitle.textContent = 'Thêm giao dịch mới';
            addModeToggle.classList.remove('hidden');
            currentTransactionType = 'expense';
            updateFormUI();
            openAddEditModal();
        }

        function setupFormForEdit(id) {
            const transaction = allTransactions.find(t => t.id === id); if (!transaction) return;
            form.reset();
            editingIdInput.value = id;
            descriptionInput.value = transaction.description;
            amountInput.value = transaction.amount;
            categoryInput.value = transaction.category;
            formTitle.textContent = 'Sửa giao dịch';
            addModeToggle.classList.add('hidden');

            // Update button style and text without destroying loading structure
            saveTransactionBtn.className = "w-full p-4 text-white font-bold rounded-lg shadow-md transition-all duration-200 touch-target bg-indigo-600 hover:bg-indigo-700";
            const btnTextEl = document.getElementById('btn-text');
            if (btnTextEl) {
                btnTextEl.innerHTML = `<i class="fas fa-save mr-2"></i> Lưu thay đổi`;
            }

            openAddEditModal();
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            tabNav.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.tab-btn');
                if (tabButton) switchTab(tabButton.dataset.tab);
            });

            // ⭐ SỰ KIỆN CHO NÚT TOGGLE ĐÃ ĐƯỢC PHỤC HỒI
            addModeToggle.addEventListener('click', (e) => {
                const btn = e.target.closest('.type-toggle-btn');
                if (btn) {
                    currentTransactionType = btn.dataset.type;
                    updateFormUI();
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                console.log('Form submitted!'); // Debug log

                // Validate form
                if (!Validator.validateForm()) {
                    Toast.error('Vui lòng kiểm tra lại thông tin đã nhập');
                    return;
                }

                // Show loading state
                LoadingState.setButtonLoading('save-transaction-btn', true);

                try {
                    // Simulate processing time for better UX
                    await new Promise(resolve => setTimeout(resolve, 500));

                    const id = editingIdInput.value;
                    const description = descriptionInput.value.trim();
                    // Xử lý số tiền: loại bỏ dấu chấm và chuyển thành số
                    const cleanAmount = amountInput.value.replace(/[\s,]/g, '').replace(/\./g, '');
                    const amount = parseFloat(cleanAmount);
                    const category = categoryInput.value;

                    console.log('Form data:', { id, description, amount, category, type: currentTransactionType }); // Debug log

                    // Save last used category for smart defaults
                    localStorage.setItem('lastUsedCategory', category);

                    if (id) {
                        // Edit existing transaction
                        const index = allTransactions.findIndex(t => t.id === id);
                        if (index > -1) {
                            const originalTransaction = allTransactions[index];
                            allTransactions[index] = {
                                ...originalTransaction,
                                description,
                                amount,
                                category
                            };
                            Toast.success('Giao dịch đã được cập nhật thành công!');
                        }
                    } else {
                        // Add new transaction
                        const newTransaction = {
                            id: crypto.randomUUID(),
                            description,
                            amount,
                            category,
                            type: currentTransactionType,
                            createdAt: new Date()
                        };
                        allTransactions.push(newTransaction);

                        const typeText = currentTransactionType === 'expense' ? 'chi tiêu' : 'thu nhập';
                        Toast.success(`Đã thêm ${typeText} ${formatCurrency(amount)} thành công!`);
                    }

                    Storage.set(TRANSACTIONS_KEY, allTransactions);
                    processAndRenderData();
                    closeAddEditModal();

                    // Smart form focus management
                    setTimeout(() => {
                        if (!addEditModal.classList.contains('modal-show')) {
                            addFab.focus();
                        }
                    }, 500);

                    // Success animation for FAB
                    setTimeout(() => {
                        addFab.style.transform = 'scale(1.2)';
                        addFab.style.backgroundColor = '#22c55e';
                        setTimeout(() => {
                            addFab.style.transform = '';
                            addFab.style.backgroundColor = '';
                        }, 300);
                    }, 600);

                } catch (error) {
                    Toast.error('Có lỗi xảy ra, vui lòng thử lại');
                    console.error('Transaction save error:', error);
                } finally {
                    LoadingState.setButtonLoading('save-transaction-btn', false);
                }
            });

            addFab.addEventListener('click', setupFormForAdd);
            closeModalBtn.addEventListener('click', closeAddEditModal); // ⭐ Gán sự kiện cho nút đóng modal

            mainContentEl.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) { setupFormForEdit(editBtn.dataset.id); return; }
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) { transactionToDeleteId = deleteBtn.dataset.id; deleteModal.classList.remove('hidden'); }
            });

            confirmDeleteBtn.addEventListener('click', async () => {
                if (!transactionToDeleteId) return;

                // Show loading state
                const textEl = confirmDeleteBtn.querySelector('.delete-btn-text');
                const loadingEl = confirmDeleteBtn.querySelector('.delete-btn-loading');

                confirmDeleteBtn.disabled = true;
                textEl.classList.add('hidden');
                loadingEl.classList.remove('hidden');

                try {
                    // Simulate processing time
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Find transaction for success message
                    const transaction = allTransactions.find(t => t.id === transactionToDeleteId);

                    allTransactions = allTransactions.filter(t => t.id !== transactionToDeleteId);
                    Storage.set(TRANSACTIONS_KEY, allTransactions);
                    processAndRenderData();
                    closeDeleteModal();

                    if (transaction) {
                        Toast.success(`Đã xóa giao dịch "${transaction.description}" thành công`);
                    }
                } catch (error) {
                    Toast.error('Có lỗi xảy ra khi xóa giao dịch');
                } finally {
                    // Reset button state
                    confirmDeleteBtn.disabled = false;
                    textEl.classList.remove('hidden');
                    loadingEl.classList.add('hidden');
                }
            });
            function closeDeleteModal() { transactionToDeleteId = null; deleteModal.classList.add('hidden'); }
            cancelDeleteBtn.addEventListener('click', closeDeleteModal);

            addCategoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newCat = newCategoryNameInput.value.trim();

                if (!newCat) {
                    Toast.error('Vui lòng nhập tên danh mục');
                    return;
                }

                if (allCategories.find(c => c.toLowerCase() === newCat.toLowerCase())) {
                    Toast.error('Danh mục này đã tồn tại');
                    return;
                }

                allCategories.push(newCat);
                Storage.set(CATEGORIES_KEY, allCategories);
                renderCategories();
                newCategoryNameInput.value = '';
                Toast.success(`Đã thêm danh mục "${newCat}" thành công`);
            });

            categoryListEl.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-category-btn');
                if (deleteBtn) {
                    const catToDelete = deleteBtn.dataset.category;

                    ConfirmDialog.show({
                        title: 'Xóa danh mục',
                        message: `Bạn có chắc muốn xóa danh mục "${catToDelete}"?\n\nHành động này sẽ không ảnh hưởng tới các giao dịch cũ.`,
                        type: 'danger',
                        confirmText: 'Xóa danh mục',
                        onConfirm: async () => {
                            // Simulate processing time
                            await new Promise(resolve => setTimeout(resolve, 500));

                            allCategories = allCategories.filter(c => c !== catToDelete);
                            delete allBudgets[catToDelete];
                            Storage.set(CATEGORIES_KEY, allCategories);
                            Storage.set(BUDGETS_KEY, allBudgets);
                            renderCategories();
                            Toast.success(`Đã xóa danh mục "${catToDelete}" thành công`);
                        }
                    });
                }
                const editBtn = e.target.closest('.edit-category-btn');
                if (editBtn) showEditCategoryModal(editBtn.dataset.category);
            });

            editCategoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const oldName = oldCategoryNameInput.value;
                const newName = editCategoryNameInput.value.trim();
                if (!newName || newName === oldName) { closeEditCategoryModal(); return; }
                if (allCategories.find(c => c.toLowerCase() === newName.toLowerCase())) {
                    Toast.error('Tên danh mục đã tồn tại');
                    return;
                }
                const categoryIndex = allCategories.findIndex(c => c === oldName);
                if (categoryIndex > -1) allCategories[categoryIndex] = newName;
                allTransactions.forEach(t => { if (t.category === oldName) t.category = newName; });
                if (allBudgets[oldName]) { allBudgets[newName] = allBudgets[oldName]; delete allBudgets[oldName]; }
                Storage.set(CATEGORIES_KEY, allCategories);
                Storage.set(TRANSACTIONS_KEY, allTransactions);
                Storage.set(BUDGETS_KEY, allBudgets);
                renderCategories();
                processAndRenderData();
                closeEditCategoryModal();
                Toast.success(`Đã đổi tên danh mục thành "${newName}" thành công`);
            });
            cancelEditCategoryBtn.addEventListener('click', closeEditCategoryModal);

            budgetListEl.addEventListener('change', async (e) => {
                if (e.target.classList.contains('budget-input')) {
                    const category = e.target.dataset.category;
                    const amount = parseInt(e.target.value, 10) || 0;

                    // Show loading feedback
                    e.target.style.opacity = '0.6';
                    e.target.disabled = true;

                    try {
                        // Simulate processing time
                        await new Promise(resolve => setTimeout(resolve, 300));

                        if (amount > 0) {
                            allBudgets[category] = amount;
                            Toast.success(`Đã cập nhật ngân sách cho "${category}": ${formatCurrency(amount)}`);
                        } else {
                            delete allBudgets[category];
                            Toast.info(`Đã xóa ngân sách cho "${category}"`);
                        }

                        Storage.set(BUDGETS_KEY, allBudgets);
                        renderBudgetView();
                    } catch (error) {
                        Toast.error('Có lỗi xảy ra khi cập nhật ngân sách');
                    } finally {
                        e.target.style.opacity = '1';
                        e.target.disabled = false;
                    }
                }
            });

            dateRangeFilter.addEventListener('change', () => { if (dateRangeFilter.value === 'custom') { customDateFilters.classList.remove('hidden'); } else { customDateFilters.classList.add('hidden'); startDateInput.value = ''; endDateInput.value = ''; processAndRenderData(); } });

            exportCsvBtn.addEventListener('click', async () => {
                if (allTransactions.length === 0) {
                    Toast.warning("Không có dữ liệu để xuất");
                    return;
                }

                // Show loading state
                const originalText = exportCsvBtn.innerHTML;
                exportCsvBtn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center;"><span class="spinner"></span><span>Đang xuất dữ liệu...</span></span>';
                exportCsvBtn.disabled = true;

                try {
                    // Simulate processing time for large datasets
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    let csvContent = "data:text/csv;charset=utf-8,\uFEFFID,Mô tả,Số tiền,Loại,Danh mục,Ngày tạo\n";
                    allTransactions.forEach(t => {
                        const row = [
                            t.id,
                            `"${t.description.replace(/"/g, '""')}"`,
                            t.amount,
                            t.type,
                            t.category,
                            t.createdAt.toISOString()
                        ].join(",");
                        csvContent += row + "\n";
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `chi-tieu-${new Date().toISOString().slice(0, 10)}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    Toast.success(`Đã xuất ${allTransactions.length} giao dịch thành công!`);
                } catch (error) {
                    Toast.error('Có lỗi xảy ra khi xuất dữ liệu');
                } finally {
                    // Reset button state
                    exportCsvBtn.innerHTML = originalText;
                    exportCsvBtn.disabled = false;
                }
            });

            // Filter event listeners
            [searchInput, startDateInput, endDateInput, minAmountInput, maxAmountInput].forEach(el => {
                el.addEventListener('input', () => {
                    if (document.activeElement === startDateInput || document.activeElement === endDateInput) {
                        dateRangeFilter.value = 'custom';
                        customDateFilters.classList.remove('hidden');
                    }
                    processAndRenderData();
                });
            });

            [typeFilter, categoryFilter, sortFilter].forEach(el => {
                el.addEventListener('change', processAndRenderData);
            });

            // Clear filters button
            clearFiltersBtn.addEventListener('click', clearAllFilters);

            // Advanced filter toggle
            advancedFilterToggle.addEventListener('click', () => {
                const isHidden = advancedFilters.classList.contains('hidden');
                if (isHidden) {
                    advancedFilters.classList.remove('hidden');
                    advancedFilterToggle.innerHTML = '<i class="fas fa-filter mr-1"></i>Thu gọn';
                } else {
                    advancedFilters.classList.add('hidden');
                    advancedFilterToggle.innerHTML = '<i class="fas fa-filter mr-1"></i>Nâng cao';
                }
            });

            // Format amount inputs
            [minAmountInput, maxAmountInput].forEach(input => {
                input.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/[^\d]/g, '');
                    if (value) {
                        value = parseInt(value).toLocaleString('vi-VN');
                        e.target.value = value;
                    }
                });
            });

            // Lưu vị trí cuộn khi người dùng cuộn
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                // Debounce để tối ưu performance
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    if (currentTab) {
                        tabScrollPositions[currentTab] = window.pageYOffset || document.documentElement.scrollTop;
                    }
                }, 100);
            }, { passive: true });
        }

        // --- FILTERS ---
        function getDateRangeFromFilter() {
            const range = dateRangeFilter.value;
            const now = new Date();
            let startDate = null, endDate = null;
            const startOfDay = (date) => new Date(date.setHours(0, 0, 0, 0));
            const endOfDay = (date) => new Date(date.setHours(23, 59, 59, 999));

            switch (range) {
                case 'today':
                    startDate = startOfDay(new Date());
                    endDate = endOfDay(new Date());
                    break;
                case 'yesterday':
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    startDate = startOfDay(yesterday);
                    endDate = endOfDay(new Date(yesterday));
                    break;
                case 'this_week':
                    const firstDayOfWeek = new Date(now);
                    firstDayOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
                    startDate = startOfDay(firstDayOfWeek);
                    endDate = endOfDay(new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000));
                    break;
                case 'last_week':
                    const lastWeekStart = new Date(now);
                    lastWeekStart.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -13 : -6));
                    startDate = startOfDay(lastWeekStart);
                    endDate = endOfDay(new Date(lastWeekStart.getTime() + 6 * 24 * 60 * 60 * 1000));
                    break;
                case 'this_month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'last_month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
                    break;
                case 'this_year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                    break;
                case 'last_year':
                    startDate = new Date(now.getFullYear() - 1, 0, 1);
                    endDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999);
                    break;
                case 'custom':
                    startDate = startDateInput.value ? startOfDay(new Date(startDateInput.value)) : null;
                    endDate = endDateInput.value ? endOfDay(new Date(endDateInput.value)) : null;
                    break;
            }
            return { startDate, endDate };
        }

        // --- REAL-TIME VALIDATION ---
        function setupRealTimeValidation() {
            // Description validation
            descriptionInput.addEventListener('input', () => {
                const error = Validator.validateDescription(descriptionInput.value);
                if (error) {
                    Validator.showError('description', error);
                } else {
                    Validator.clearError('description');
                }
            });

            // Amount validation - đơn giản, chỉ validate
            amountInput.addEventListener('input', (e) => {
                const error = Validator.validateAmount(e.target.value);
                if (error) {
                    Validator.showError('amount', error);
                } else {
                    Validator.clearError('amount');
                }
            });

            // Category validation
            categoryInput.addEventListener('change', () => {
                const error = Validator.validateCategory(categoryInput.value);
                if (error) {
                    Validator.showError('category', error);
                } else {
                    Validator.clearError('category');
                }
            });

            // Mobile keyboard optimization
            setupMobileKeyboardHandling();
        }

        // --- MOBILE KEYBOARD HANDLING ---
        function setupMobileKeyboardHandling() {
            // Handle virtual keyboard appearance
            let initialViewportHeight = window.innerHeight;

            window.addEventListener('resize', () => {
                const currentHeight = window.innerHeight;
                const heightDifference = initialViewportHeight - currentHeight;

                // If keyboard is likely open (height reduced significantly)
                if (heightDifference > 150) {
                    document.body.classList.add('keyboard-open');
                    // Adjust modal position if needed
                    const modal = document.getElementById('modal-content');
                    if (addEditModal.classList.contains('modal-show')) {
                        modal.style.maxHeight = `${currentHeight - 100}px`;
                    }
                } else {
                    document.body.classList.remove('keyboard-open');
                    const modal = document.getElementById('modal-content');
                    modal.style.maxHeight = '85vh';
                }
            });

            // Prevent zoom on input focus (iOS)
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    // Scroll input into view
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });

            // Handle Enter key for better form navigation
            descriptionInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    amountInput.focus();
                }
            });

            amountInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    categoryInput.focus();
                }
            });
        }

        // --- ENHANCED UX FEATURES ---
        const EnhancedUX = {
            init() {
                this.setupSmartDefaults();
                this.setupProgressiveEnhancement();
                this.setupAccessibilityFeatures();
            },

            setupSmartDefaults() {
                // Remember last used category
                const lastCategory = localStorage.getItem('lastUsedCategory');
                if (lastCategory && allCategories.includes(lastCategory)) {
                    categoryInput.value = lastCategory;
                }

                // Auto-suggest amounts based on history
                amountInput.addEventListener('focus', () => {
                    const recentAmounts = allTransactions
                        .slice(0, 10)
                        .map(t => t.amount)
                        .filter((amount, index, arr) => arr.indexOf(amount) === index)
                        .slice(0, 3);

                    if (recentAmounts.length > 0 && !amountInput.value) {
                        const suggestion = recentAmounts[0];
                        amountInput.placeholder = `Gợi ý: ${formatCurrency(suggestion)}`;
                    }
                });
            },

            setupProgressiveEnhancement() {
                // Add visual feedback for successful actions
                const originalAddTransaction = form.onsubmit;

                // Enhanced form submission will be handled in main form submit handler
            },

            setupAccessibilityFeatures() {
                // Add ARIA labels and descriptions
                addFab.setAttribute('aria-label', 'Thêm giao dịch mới');

                // Announce important changes to screen readers
                const announcer = document.createElement('div');
                announcer.setAttribute('aria-live', 'polite');
                announcer.setAttribute('aria-atomic', 'true');
                announcer.className = 'sr-only';
                document.body.appendChild(announcer);

                // Announce balance changes
                const originalUpdateDashboard = updateHomeDashboard;
                window.updateHomeDashboard = function (transactions) {
                    const oldBalance = balanceEl.textContent;
                    originalUpdateDashboard(transactions);
                    const newBalance = balanceEl.textContent;

                    if (oldBalance !== newBalance) {
                        announcer.textContent = `Số dư đã cập nhật: ${newBalance}`;
                    }
                };

                // Keyboard navigation improvements
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.target.classList.contains('tab-btn')) {
                        e.target.click();
                    }
                });
            }
        };

        // --- PERFORMANCE OPTIMIZATION ---
        function preloadModalAnimations() {
            const modal = document.getElementById('add-edit-modal');
            const modalContent = document.getElementById('modal-content');

            // Force GPU layer creation
            modal.style.transform = 'translateZ(0)';
            modalContent.style.transform = 'translate3d(0, 100%, 0)';
            modalContent.style.backfaceVisibility = 'hidden';

            // Force reflow để browser tạo composite layer
            modal.offsetHeight;
            modalContent.offsetHeight;

            // Cleanup sau khi preload
            setTimeout(() => {
                modal.style.transform = '';
                modalContent.style.transform = 'translate3d(0, 100%, 0)';
            }, 100);
        }

        // Performance monitoring (optional)
        function measureModalPerformance() {
            if (performance.mark) {
                performance.mark('modal-open-start');

                setTimeout(() => {
                    performance.mark('modal-open-end');
                    performance.measure('modal-animation', 'modal-open-start', 'modal-open-end');

                    const measures = performance.getEntriesByName('modal-animation');
                    if (measures.length > 0) {
                        console.log(`Modal animation took: ${measures[0].duration.toFixed(2)}ms`);
                    }
                }, 300);
            }
        }

        // --- INITIAL APP SETUP ---
        function initializeApp() {
            loadData();
            renderCategories();
            setupEventListeners(); // Gộp các sự kiện vào một hàm
            setupRealTimeValidation(); // Thêm real-time validation
            processAndRenderData();
            Toast.init(); // Initialize toast system
            MobileUX.init(); // Initialize mobile UX enhancements
            MobileUX.setupAdvancedInteractions(); // Setup advanced interactions
            EnhancedUX.init(); // Initialize enhanced UX features

            loadingEl.classList.add('hidden');
            mainContentEl.classList.remove('hidden');
            currentTab = 'home'; // Khởi tạo tab hiện tại
            switchTab('home');

            // Preload animations cho performance
            setTimeout(preloadModalAnimations, 100);

            // Show welcome message for first-time users
            if (allTransactions.length === 0) {
                setTimeout(() => {
                    Toast.info('Chào mừng! Nhấn nút + để thêm giao dịch đầu tiên của bạn', 6000);
                }, 1000);
            }
        }

        // --- COPY CONTACT FUNCTION ---
        function copyContact() {
            const contactInfo = "Facebook: vuhoangha.dev\nDeveloper: Vũ Hoàng Hà";

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(contactInfo).then(() => {
                    Toast.success('Đã copy thông tin liên hệ vào clipboard!');
                }).catch(() => {
                    fallbackCopyTextToClipboard(contactInfo);
                });
            } else {
                fallbackCopyTextToClipboard(contactInfo);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                Toast.success('Đã copy thông tin liên hệ!');
            } catch (err) {
                Toast.error('Không thể copy. Vui lòng copy thủ công.');
            }

            document.body.removeChild(textArea);
        }

        // --- PWA SAFE AREA HANDLER ---
        function handlePWASafeArea() {
            // Phát hiện PWA mode
            const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true;

            if (isPWA) {
                document.body.classList.add('pwa-mode');

                // Xử lý safe area cho iOS
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                if (isIOS) {
                    // Đảm bảo viewport height được tính đúng
                    const setViewportHeight = () => {
                        const vh = window.innerHeight * 0.01;
                        document.documentElement.style.setProperty('--vh', `${vh}px`);
                    };

                    setViewportHeight();
                    window.addEventListener('resize', setViewportHeight);
                    window.addEventListener('orientationchange', () => {
                        setTimeout(setViewportHeight, 100);
                    });

                    // Ngăn chặn scroll bounce
                    document.addEventListener('touchmove', (e) => {
                        if (e.target.closest('#mainContent') || e.target.closest('#add-edit-modal')) {
                            return;
                        }
                        e.preventDefault();
                    }, { passive: false });
                }
            }
        }

        // --- SCROLL PREVENTION FOR HEADER ---
        function preventHeaderOverscroll() {
            let lastScrollTop = 0;
            const header = document.querySelector('header');

            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                // Ngăn scroll âm (overscroll)
                if (scrollTop < 0) {
                    window.scrollTo(0, 0);
                    return;
                }

                lastScrollTop = scrollTop;
            }, { passive: false });

            // Đảm bảo header luôn ở vị trí đúng
            if (header) {
                header.style.position = 'fixed';
                header.style.top = '0';
                header.style.left = '0';
                header.style.right = '0';
                header.style.zIndex = '1000';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            handlePWASafeArea();
            preventHeaderOverscroll();
            initializeApp();
        });
    </script>
</body>

</html>